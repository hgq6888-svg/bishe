<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>æ™ºèƒ½è‡ªä¹ å®¤ç®¡ç†ç³»ç»Ÿ</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
:root { --primary: #2563eb; --bg: #f3f4f6; --text: #1f2937; --sidebar: #1e293b; }
body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

/* ä¾§è¾¹æ  */
.sidebar { width: 220px; background: var(--sidebar); color: white; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; }
.sidebar h2 { font-size: 1.2rem; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
.nav-item { padding: 12px; margin-bottom: 5px; cursor: pointer; border-radius: 8px; color: #94a3b8; transition: 0.2s; display: flex; gap: 10px; align-items: center; }
.nav-item:hover, .nav-item.active { background: var(--primary); color: white; }
.nav-item span { font-size: 1.2rem; }

/* ä¸»å†…å®¹ */
.main { flex: 1; padding: 30px; overflow-y: auto; }
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
.card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
.card h3 { margin-top: 0; border-left: 4px solid var(--primary); padding-left: 10px; font-size: 1.1rem; }

/* ä»ªè¡¨ç›˜ */
.kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
.kpi-box { background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0; }
.kpi-val { font-size: 1.5rem; font-weight: bold; color: var(--primary); margin: 5px 0; }

/* åº§ä½ */
.seat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; }
.seat-item { border: 2px solid #e2e8f0; padding: 15px; border-radius: 10px; text-align: center; cursor: pointer; position: relative; background: white; transition: 0.2s; }
.seat-item:hover { transform: translateY(-3px); box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
/* åŸºç¡€çŠ¶æ€è‰² */
.seat-item.free { border-color: #10b981; background: #ecfdf5; color: #047857; }
.seat-item.reserved { border-color: #f59e0b; background: #fffbeb; color: #b45309; }
.seat-item.inuse { border-color: #3b82f6; background: #eff6ff; color: #1e40af; }

/* æŠ¥è¡¨é¡µé¢ä¸“æœ‰æ ·å¼ */
.stats-toolbar { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
.chart-container { position: relative; height: 300px; width: 100%; }
.chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.heat-map-legend { display: flex; gap:10px; font-size: 0.8rem; justify-content: flex-end; margin-bottom: 10px; }
.heat-box { width: 15px; height: 15px; display: inline-block; vertical-align: middle; border-radius: 3px; }

/* è¡¨å•ä¸æŒ‰é’® */
input, select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
button { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; }
button.secondary { background: #64748b; }
button.del { background: #ef4444; width: auto; padding: 5px 10px; font-size: 0.8rem; }
table { width: 100%; border-collapse: collapse; }
th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
th { background: #f8fafc; font-weight: 600; color: #64748b; }

/* è§†å›¾åˆ‡æ¢ */
.view-section { display: none; }
.view-section.active { display: block; animation: fadeIn 0.3s; }
@keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
</style>
</head>
<body>

<div class="sidebar">
    <h2>ğŸ“š æ™ºæ…§è‡ªä¹ å®¤</h2>
    <div class="nav-item active" onclick="switchView('dashboard')"><span>ğŸ“Š</span> æ€»è§ˆå¤§å±</div>

    {% if role == 'admin' %}
    <div class="nav-item" onclick="switchView('stats')"><span>ğŸ“ˆ</span> æ•°æ®æŠ¥è¡¨</div>
    {% endif %}

    <div class="nav-item" onclick="switchView('reserve')"><span>ğŸ“…</span> é¢„çº¦ä¸­å¿ƒ</div>
    <div class="nav-item" onclick="switchView('profile')"><span>ğŸ‘¤</span> ä¸ªäººä¸­å¿ƒ</div>
    {% if role == 'admin' %}
    <div class="nav-item" onclick="switchView('admin')"><span>âš™ï¸</span> åå°ç®¡ç†</div>
    {% endif %}
    <div class="nav-item" style="margin-top:auto" onclick="location.href='/logout'"><span>ğŸšª</span> é€€å‡ºç™»å½•</div>
</div>

<div class="main">
    <div class="header">
        <h1 id="page-title">æ€»è§ˆå¤§å±</h1>
        <div>ç”¨æˆ·: {{ current_user }} ({{ 'ç®¡ç†å‘˜' if role=='admin' else 'ç”¨æˆ·' }})</div>
    </div>

    <div id="view-dashboard" class="view-section active">
        <div class="card">
            <h3>ç¯å¢ƒç›‘æµ‹</h3>
            <div class="kpi-grid">
                <div class="kpi-box"><div>æ¸©åº¦</div><div class="kpi-val"><span id="val-temp">--</span>â„ƒ</div></div>
                <div class="kpi-box"><div>æ¹¿åº¦</div><div class="kpi-val"><span id="val-humi">--</span>%</div></div>
                <div class="kpi-box"><div>å…‰ç…§</div><div class="kpi-val"><span id="val-lux">--</span>Lx</div></div>
                <div class="kpi-box"><div>æ›´æ–°</div><div class="kpi-val" style="font-size:1rem;margin-top:10px" id="val-time">--</div></div>
            </div>
        </div>
        <div class="card">
            <h3>åº§ä½å®æ—¶çŠ¶æ€</h3>
            <div class="seat-grid" id="seat-grid"></div>
        </div>
    </div>

    {% if role == 'admin' %}
    <div id="view-stats" class="view-section">
        <div class="stats-toolbar">
            <label>æ—¶é—´èŒƒå›´ï¼š</label>
            <select id="stats-days" onchange="loadStats()" style="width:auto;margin:0">
                <option value="1">è¿‘ 1 å¤© (24h)</option>
                <option value="7" selected>è¿‘ 7 å¤©</option>
                <option value="30">è¿‘ 30 å¤©</option>
            </select>
            <div style="flex:1"></div>
            <button class="secondary" onclick="exportReportPDF()" style="width:auto">ğŸ“„ å¯¼å‡º PDF æŠ¥è¡¨</button>
        </div>

        <div id="report-content">
            <div class="card">
                <h3>ç»Ÿè®¡æ¦‚è§ˆ</h3>
                <div class="kpi-grid">
                    <div class="kpi-box">
                        <div style="font-size:0.9rem;color:#666">å¹³å‡ä½¿ç”¨æ—¶é•¿</div>
                        <div class="kpi-val" id="st-avg-dur">--</div>
                        <div style="font-size:0.8rem">åˆ†é’Ÿ/æ¬¡</div>
                    </div>
                    <div class="kpi-box">
                        <div style="font-size:0.9rem;color:#666">é«˜å³°æ—¶æ®µ</div>
                        <div class="kpi-val" id="st-peak">--</div>
                    </div>
                    <div class="kpi-box">
                        <div style="font-size:0.9rem;color:#666">çƒ­é—¨åº§ä½</div>
                        <div class="kpi-val" id="st-top-seat">--</div>
                    </div>
                    <div class="kpi-box">
                        <div style="font-size:0.9rem;color:#666">è®¾å¤‡çŠ¶æ€</div>
                        <div class="kpi-val" id="st-device">--</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>ç¯å¢ƒè¶‹åŠ¿ä¸é¢„æµ‹ (åŒYè½´ + è¶‹åŠ¿çº¿)</h3>
                <div class="chart-container">
                    <canvas id="chart-env"></canvas>
                </div>
            </div>

            <div class="chart-row">
                <div class="card">
                    <h3>æ—¶æ®µåˆ†å¸ƒ (çƒ­åŠ›ç»Ÿè®¡)</h3>
                    <div class="chart-container" style="height:250px">
                        <canvas id="chart-heat"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3>ç¯å¢ƒ-é¢„çº¦å…³è” (æ¸©åº¦ vs é¢„çº¦é‡)</h3>
                    <div class="chart-container" style="height:250px">
                        <canvas id="chart-scatter"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>åº§ä½çƒ­é—¨åº¦åœ°å›¾</h3>
                <div class="heat-map-legend">
                    <span><span class="heat-box" style="background:#e0f2fe"></span> å†·é—¨</span>
                    <span><span class="heat-box" style="background:#3b82f6"></span> çƒ­é—¨</span>
                    <span><span class="heat-box" style="background:#1e40af"></span> çˆ†æ»¡</span>
                </div>
                <div class="seat-grid" id="stats-seat-map"></div>
            </div>
        </div>
    </div>
    {% endif %}

    <div id="view-reserve" class="view-section">
        <div class="card" style="max-width:500px; margin:0 auto">
            <h3>æäº¤æ–°é¢„çº¦</h3>
            <label>é€‰æ‹©åº§ä½</label>
            <select id="res-seat"><option>åŠ è½½ä¸­...</option></select>
            <label>æ—¶é•¿ (åˆ†é’Ÿ)</label>
            <input type="number" id="res-min" value="120">
            <button onclick="doReserve()">ç«‹å³é¢„çº¦</button>
            <p style="color:#666;font-size:0.9rem;margin-top:15px">æç¤ºï¼šé¢„çº¦åè¯·ä½¿ç”¨ç»‘å®šçš„å®ä½“å¡åœ¨è®¾å¤‡ä¸Šç­¾åˆ°ã€‚</p>
        </div>
    </div>

    <div id="view-profile" class="view-section">
        <div class="card" style="max-width:500px; margin:0 auto">
            <h3>æˆ‘çš„ç»‘å¡ä¿¡æ¯</h3>
            <div style="background:#f8fafc; padding:20px; border-radius:8px; text-align:center; margin-bottom:20px">
                <div style="color:#64748b">å½“å‰ç»‘å®šå¡å· (UID)</div>
                <div id="my-uid" style="font-size:2rem; font-weight:bold; color:#1f2937; margin:10px 0">--</div>
                <div id="bind-tip" style="color:#ef4444">æœªç»‘å®š</div>
            </div>
            <label>ç»‘å®šæ–°å¡å· (è¾“å…¥å®ä½“å¡UID)</label>
            <input id="input-uid" placeholder="ä¾‹å¦‚: A1B2C3D4">
            <button onclick="doBind()">ä¿å­˜ç»‘å®š</button>
        </div>
    </div>

    {% if role == 'admin' %}
    <div id="view-admin" class="view-section">
        <div class="card">
            <h3>ç”¨æˆ·ç®¡ç†</h3>
            <div style="display:flex; gap:10px; margin-bottom:15px">
                <input id="adm-name" placeholder="ç”¨æˆ·å" style="margin:0">
                <input id="adm-uid" placeholder="å¡å·UID" style="margin:0">
                <button onclick="admAddUser()" style="width:auto">æ·»åŠ ç”¨æˆ·</button>
            </div>
            <table>
                <thead><tr><th>ç”¨æˆ·</th><th>å¡å·</th><th>è§’è‰²</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="user-table"></tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<script>
const CUR_USER = "{{ current_user }}";
const CUR_ROLE = "{{ role }}";
let chartInsts = {}; // ä¿å­˜å›¾è¡¨å®ä¾‹
let currentSeatMap = {}; // ä¿å­˜åº§ä½çƒ­åº¦æ•°æ®

function switchView(id) {
    document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));

    // å¢åŠ åˆ¤æ–­ï¼šå¦‚æœæ˜¯éç®¡ç†å‘˜è¯•å›¾è®¿é—®ä¸å­˜åœ¨çš„statsé¡µé¢ï¼Œä¸æ‰§è¡Œæ“ä½œ
    const target = document.getElementById('view-' + id);
    if (target) {
        target.classList.add('active');
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.getElementById('page-title').innerText = event.currentTarget.innerText.trim().substring(2);

        if(id === 'profile') loadProfile();
        if(id === 'stats') loadStats();
    }
}

// --- æ•°æ®åŠ è½½é€»è¾‘ ---
async function loadState() {
    try {
        const r = await fetch('/api/state');
        if(r.status === 401) return location.reload();
        const d = await r.json();

        // é¦–é¡µ-ç¯å¢ƒ
        if(d.latest) {
            document.getElementById('val-temp').innerText = d.latest.temp || '--';
            document.getElementById('val-humi').innerText = d.latest.humi || '--';
            document.getElementById('val-lux').innerText = d.latest.lux || '--';
            document.getElementById('val-time').innerText = (d.latest.created_at||'').split(' ')[1] || '--';
        }

        // é¦–é¡µ-åº§ä½
        const grid = document.getElementById('seat-grid');
        const sel = document.getElementById('res-seat');
        grid.innerHTML = '';
        if(sel.options.length <= 1) sel.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';

        d.seats.forEach(s => {
            const st = s.state;
            const cls = st === 'RESERVED' ? 'reserved' : (st === 'IN_USE' ? 'inuse' : 'free');
            const txt = st === 'RESERVED' ? 'å·²é¢„çº¦' : (st === 'IN_USE' ? 'ä½¿ç”¨ä¸­' : 'ç©ºé—²');
            let btnHtml = '';
            const isMine = s.active_reservation?.user === CUR_USER;
            if(s.active_reservation && (CUR_ROLE === 'admin' || isMine)) {
                const action = s.active_reservation.status === 'ACTIVE' ? 'å–æ¶ˆé¢„çº¦' : 'å¼ºåˆ¶ç­¾é€€';
                btnHtml = `<button class="del" style="width:100%;margin-top:5px" onclick="event.stopPropagation();doCancel(${s.active_reservation.id})">${action}</button>`;
            }
            const div = document.createElement('div');
            div.className = `seat-item ${cls}`;
            div.innerHTML = `<div style="font-weight:bold;font-size:1.2rem">${s.display}</div><div style="font-size:0.9rem;margin:5px 0">${txt}</div>${btnHtml}`;
            if(st === 'FREE') {
                div.onclick = () => {
                    document.querySelector('.nav-item[onclick*="reserve"]').click();
                    setTimeout(() => document.getElementById('res-seat').value = s.seat_id, 50);
                };
                if(!document.querySelector(`#res-seat option[value="${s.seat_id}"]`)) {
                    const opt = document.createElement('option');
                    opt.value = s.seat_id; opt.innerText = s.display;
                    sel.appendChild(opt);
                }
            }
            grid.appendChild(div);
        });

    } catch(e) {}
}

// --- å¢å¼ºæŠ¥è¡¨é€»è¾‘ (ä¿®å¤äº†ç©ºæ•°æ®å´©æºƒçš„é—®é¢˜) ---
async function loadStats() {
    // å¢åŠ å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœé¡µé¢ä¸Šæ²¡æœ‰ stats-days å…ƒç´ ï¼ˆè¯´æ˜ä¸æ˜¯ç®¡ç†å‘˜ï¼‰ï¼Œç›´æ¥è¿”å›
    const daysEl = document.getElementById('stats-days');
    if (!daysEl) return;

    const days = daysEl.value;
    const r = await fetch('/api/stats?days=' + days);
    if(!r.ok) return;
    const d = await r.json();

    // 1. æ›´æ–°ç»Ÿè®¡å¡ç‰‡
    document.getElementById('st-avg-dur').innerText = d.stats.avg_duration;
    document.getElementById('st-peak').innerText = d.stats.peak_hour;
    document.getElementById('st-top-seat').innerText = d.stats.top_seat;
    const devSt = d.stats.device_online ? "ğŸŸ¢ åœ¨çº¿" : "ğŸ”´ ç¦»çº¿";
    document.getElementById('st-device').innerText = devSt;
    document.getElementById('st-device').style.color = d.stats.device_online ? '#10b981' : '#ef4444';

    // 2. ç¯å¢ƒè¶‹åŠ¿ (å¢åŠ ç©ºæ•°æ®æ£€æŸ¥ï¼)
    let envChartData = { labels: [], datasets: [] };

    // åªæœ‰å½“æœ‰æ ‡ç­¾æ•°æ®æ—¶ï¼Œæ‰è¿›è¡Œå¤æ‚çš„è¿çº¿æ‹¼æ¥
    if (d.env && d.env.labels && d.env.labels.length > 0) {
        const fullLabels = d.env.labels.concat(d.env.pred_labels);

        // æ•°æ®æ‹¼æ¥ä¼˜åŒ–
        const lastRealT = d.env.temp.length > 0 ? d.env.temp[d.env.temp.length - 1] : null;
        const lastRealH = d.env.humi.length > 0 ? d.env.humi[d.env.humi.length - 1] : null;

        const realTemp = d.env.temp.concat(new Array(d.env.pred_labels.length).fill(null));
        const realHumi = d.env.humi.concat(new Array(d.env.pred_labels.length).fill(null));

        // è®¡ç®—å¡«å……é•¿åº¦ï¼Œé˜²æ­¢ length-1 < 0 å¯¼è‡´æŠ¥é”™
        const padLen = Math.max(0, d.env.labels.length - 1);

        let predTempPad = new Array(padLen).fill(null);
        predTempPad.push(lastRealT);
        const predTemp = predTempPad.concat(d.env.pred_temp);

        let predHumiPad = new Array(padLen).fill(null);
        predHumiPad.push(lastRealH);
        const predHumi = predHumiPad.concat(d.env.pred_humi);

        envChartData = {
            labels: fullLabels,
            datasets: [
                {
                    label: 'æ¸©åº¦(â„ƒ)', data: realTemp, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    fill: true, yAxisID: 'y', tension: 0.4, pointRadius: 0, pointHoverRadius: 4
                },
                {
                    label: 'æ¹¿åº¦(%)', data: realHumi, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true, yAxisID: 'y1', tension: 0.4, pointRadius: 0, pointHoverRadius: 4
                },
                {
                    label: 'é¢„æµ‹æ¸©åº¦', data: predTemp, borderColor: '#ef4444', borderDash:[5,5],
                    pointRadius:0, yAxisID: 'y', tension: 0.4
                },
                {
                    label: 'é¢„æµ‹æ¹¿åº¦', data: predHumi, borderColor: '#3b82f6', borderDash:[5,5],
                    pointRadius:0, yAxisID: 'y1', tension: 0.4
                }
            ]
        };
    } else {
        // æ•°æ®ä¸ºç©ºæ—¶æ˜¾ç¤ºç©ºæç¤ºæˆ–ç©ºåæ ‡è½´
        envChartData = { labels: ["æš‚æ— æ•°æ®"], datasets: [] };
    }

    renderChart('chart-env', {
        type: 'line',
        data: envChartData,
        options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: {
                x: { ticks: { maxTicksLimit: 10 } },
                y: { type: 'linear', display: true, position: 'left', title: {display:true, text:'æ¸©åº¦ (â„ƒ)', color:'#ef4444'} },
                y1: { type: 'linear', display: true, position: 'right', grid: {drawOnChartArea: false}, title: {display:true, text:'æ¹¿åº¦ (%)', color:'#3b82f6'} }
            }
        }
    });

    // 3. æ—¶æ®µåˆ†å¸ƒ (æŸ±çŠ¶)
    const hourLabels = Object.keys(d.heatmap).sort();
    const hourData = hourLabels.map(k => d.heatmap[k]);
    renderChart('chart-heat', {
        type: 'bar',
        data: {
            labels: hourLabels.map(h=>h+"ç‚¹"),
            datasets: [{
                label: 'é¢„çº¦æ¬¡æ•°',
                data: hourData,
                backgroundColor: 'rgba(139, 92, 246, 0.6)',
                borderColor: '#8b5cf6',
                borderWidth: 1
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    // 4. å…³è”æ•£ç‚¹å›¾
    renderChart('chart-scatter', {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'æ¸©åº¦ä¸é¢„çº¦é‡',
                data: d.scatter,
                backgroundColor: '#f59e0b'
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                x: { title: {display:true, text:'æ—¥å‡æ¸©åº¦ (â„ƒ)'} },
                y: { title: {display:true, text:'æ—¥é¢„çº¦é‡'} }
            }
        }
    });

    // 5. æ¸²æŸ“åº§ä½çƒ­åŠ›åœ°å›¾
    renderSeatMap(d.seat_map);
}

function renderChart(id, config) {
    const ctx = document.getElementById(id).getContext('2d');
    if(chartInsts[id]) chartInsts[id].destroy();
    chartInsts[id] = new Chart(ctx, config);
}

function renderSeatMap(mapData) {
    const grid = document.getElementById('stats-seat-map');
    // å¤åˆ¶é¦–é¡µçš„åº§ä½åˆ—è¡¨ç»“æ„ï¼Œä½†ä¸å¸¦ç‚¹å‡»äº‹ä»¶
    fetch('/api/state').then(r=>r.json()).then(d => {
        grid.innerHTML = '';
        const maxVal = Math.max(...Object.values(mapData), 1);

        d.seats.forEach(s => {
            const count = mapData[s.seat_id] || 0;
            // è®¡ç®—çƒ­åº¦é¢œè‰²
            const ratio = count / maxVal;
            const lightness = 95 - (ratio * 60);
            const bg = `hsl(217, 91%, ${lightness}%)`;
            const color = ratio > 0.5 ? 'white' : '#1e3a8a';

            const div = document.createElement('div');
            div.className = 'seat-item';
            div.style.background = bg;
            div.style.color = color;
            div.style.borderColor = 'transparent';
            div.innerHTML = `<div style="font-weight:bold">${s.display}</div><div style="font-size:0.8rem">${count}æ¬¡</div>`;
            grid.appendChild(div);
        });
    });
}

// --- å¯¼å‡º PDF é€»è¾‘ ---
function exportReportPDF() {
    const element = document.getElementById('report-content');
    const opt = {
      margin:       10,
      filename:     'è‡ªä¹ å®¤æ•°æ®æŠ¥è¡¨.pdf',
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2, useCORS: true }, // æé«˜æ¸…æ™°åº¦
      jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    // æç¤º
    const btn = document.querySelector('button[onclick="exportReportPDF()"]');
    const oldTxt = btn.innerText;
    btn.innerText = "æ­£åœ¨ç”Ÿæˆ...";
    btn.disabled = true;

    html2pdf().set(opt).from(element).save().then(() => {
        btn.innerText = oldTxt;
        btn.disabled = false;
    });
}

// --- å…¶ä»–ä¸šåŠ¡é€»è¾‘ (ä¿æŒä¸å˜) ---
async function loadProfile() {
    const r = await fetch('/api/user/profile');
    if(r.ok) {
        const d = await r.json();
        const uid = d.uid || '';
        document.getElementById('my-uid').innerText = uid || 'æœªç»‘å®š';
        document.getElementById('bind-tip').innerText = uid ? 'âœ… çŠ¶æ€æ­£å¸¸' : 'âš ï¸ æ— æ³•é¢„çº¦';
        document.getElementById('bind-tip').style.color = uid ? '#10b981' : '#ef4444';
        document.getElementById('input-uid').value = uid;
    }
}
async function doBind() {
    const uid = document.getElementById('input-uid').value;
    if(!uid) return alert('è¯·è¾“å…¥UID');
    const r = await fetch('/api/user/bind', {method:'POST', body:JSON.stringify({uid})});
    const res = await r.json();
    if(res.ok) { alert('ç»‘å®šæˆåŠŸ'); loadProfile(); }
    else alert(res.error);
}
async function doReserve() {
    const sid = document.getElementById('res-seat').value;
    if(!sid) return alert('è¯·é€‰æ‹©åº§ä½');
    const r = await fetch('/api/reserve', {
        method:'POST', body:JSON.stringify({
            seat_id: sid, minutes: document.getElementById('res-min').value
        })
    });
    const res = await r.json();
    if(res.ok) {
        alert('é¢„çº¦æˆåŠŸï¼è¯·åœ¨15åˆ†é’Ÿå†…åˆ·å¡ç­¾åˆ°');
        document.querySelector('.nav-item[onclick*="dashboard"]').click();
        loadState();
    } else {
        if(res.need_bind) {
            if(confirm(res.error + "\n\næ˜¯å¦å»ç»‘å®šï¼Ÿ")) document.querySelector('.nav-item[onclick*="profile"]').click();
        } else {
            alert(res.error);
        }
    }
}
async function doCancel(id) {
    if(confirm('ç¡®å®šå–æ¶ˆ/ç­¾é€€ï¼Ÿ')) {
        await fetch('/api/cancel', {method:'POST', body:JSON.stringify({reservation_id:id})});
        loadState();
    }
}
async function loadUsers() {
    const r = await fetch('/api/admin/users');
    if(!r.ok) return;
    const d = await r.json();
    const tb = document.getElementById('user-table');
    tb.innerHTML = '';
    d.users.forEach(u => {
        tb.innerHTML += `<tr><td>${u.username}</td><td>${u.uid||'-'}</td><td>${u.role}</td>
        <td><button class="del" onclick="delUser(${u.id})">åˆ é™¤</button></td></tr>`;
    });
}
async function admAddUser() {
    await fetch('/api/admin/users/add', {method:'POST', body:JSON.stringify({
        username: document.getElementById('adm-name').value,
        uid: document.getElementById('adm-uid').value
    })});
    loadUsers();
}
async function delUser(id) {
    if(confirm('åˆ é™¤?')) {
        await fetch('/api/admin/users/del', {method:'POST', body:JSON.stringify({id})});
        loadUsers();
    }
}

// åˆå§‹åŒ–
loadState();
setInterval(loadState, 2000);
if(CUR_ROLE === 'admin') loadUsers();
</script>
</body>
</html>