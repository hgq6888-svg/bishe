<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>æ™ºèƒ½è‡ªä¹ å®¤ç®¡ç†ç³»ç»Ÿ</title>
<style>
:root { --primary: #2563eb; --bg: #f3f4f6; --text: #1f2937; --sidebar: #1e293b; }
body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
/* ä¾§è¾¹æ  */
.sidebar { width: 220px; background: var(--sidebar); color: white; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; }
.sidebar h2 { font-size: 1.2rem; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
.nav-item { padding: 12px; margin-bottom: 5px; cursor: pointer; border-radius: 8px; color: #94a3b8; transition: 0.2s; display: flex; gap: 10px; align-items: center; }
.nav-item:hover, .nav-item.active { background: var(--primary); color: white; }
.nav-item span { font-size: 1.2rem; }
/* ä¸»å†…å®¹ */
.main { flex: 1; padding: 30px; overflow-y: auto; }
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
.card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
.card h3 { margin-top: 0; border-left: 4px solid var(--primary); padding-left: 10px; font-size: 1.1rem; }
/* ä»ªè¡¨ç›˜ */
.kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
.kpi-box { background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0; }
.kpi-val { font-size: 1.5rem; font-weight: bold; color: var(--primary); margin: 5px 0; }
/* åº§ä½ */
.seat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; }
.seat-item { border: 2px solid #e2e8f0; padding: 15px; border-radius: 10px; text-align: center; cursor: pointer; position: relative; background: white; transition: 0.2s; }
.seat-item:hover { transform: translateY(-3px); box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
.seat-item.free { border-color: #10b981; background: #ecfdf5; color: #047857; }
.seat-item.reserved { border-color: #f59e0b; background: #fffbeb; color: #b45309; }
.seat-item.inuse { border-color: #3b82f6; background: #eff6ff; color: #1e40af; }
/* è¡¨å•ä¸æŒ‰é’® */
input, select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
button { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; }
button.del { background: #ef4444; width: auto; padding: 5px 10px; font-size: 0.8rem; }
table { width: 100%; border-collapse: collapse; }
th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
th { background: #f8fafc; font-weight: 600; color: #64748b; }
/* è§†å›¾åˆ‡æ¢ */
.view-section { display: none; }
.view-section.active { display: block; animation: fadeIn 0.3s; }
@keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
</style>
</head>
<body>

<div class="sidebar">
    <h2>ğŸ“š æ™ºæ…§è‡ªä¹ å®¤</h2>
    <div class="nav-item active" onclick="switchView('dashboard')"><span>ğŸ“Š</span> æ€»è§ˆå¤§å±</div>
    <div class="nav-item" onclick="switchView('reserve')"><span>ğŸ“…</span> é¢„çº¦ä¸­å¿ƒ</div>
    <div class="nav-item" onclick="switchView('profile')"><span>ğŸ‘¤</span> ä¸ªäººä¸­å¿ƒ</div>
    {% if role == 'admin' %}
    <div class="nav-item" onclick="switchView('admin')"><span>âš™ï¸</span> åå°ç®¡ç†</div>
    {% endif %}
    <div class="nav-item" style="margin-top:auto" onclick="location.href='/logout'"><span>ğŸšª</span> é€€å‡ºç™»å½•</div>
</div>

<div class="main">
    <div class="header">
        <h1 id="page-title">æ€»è§ˆå¤§å±</h1>
        <div>ç”¨æˆ·: {{ current_user }} ({{ 'ç®¡ç†å‘˜' if role=='admin' else 'ç”¨æˆ·' }})</div>
    </div>

    <div id="view-dashboard" class="view-section active">
        <div class="card">
            <h3>ç¯å¢ƒç›‘æµ‹</h3>
            <div class="kpi-grid">
                <div class="kpi-box"><div>æ¸©åº¦</div><div class="kpi-val"><span id="val-temp">--</span>â„ƒ</div></div>
                <div class="kpi-box"><div>æ¹¿åº¦</div><div class="kpi-val"><span id="val-humi">--</span>%</div></div>
                <div class="kpi-box"><div>å…‰ç…§</div><div class="kpi-val"><span id="val-lux">--</span>Lx</div></div>
                <div class="kpi-box"><div>æ›´æ–°</div><div class="kpi-val" style="font-size:1rem;margin-top:10px" id="val-time">--</div></div>
            </div>
        </div>
        <div class="card">
            <h3>åº§ä½çŠ¶æ€</h3>
            <div class="seat-grid" id="seat-grid"></div>
        </div>
    </div>

    <div id="view-reserve" class="view-section">
        <div class="card" style="max-width:500px; margin:0 auto">
            <h3>æäº¤æ–°é¢„çº¦</h3>
            <label>é€‰æ‹©åº§ä½</label>
            <select id="res-seat"><option>åŠ è½½ä¸­...</option></select>
            <label>æ—¶é•¿ (åˆ†é’Ÿ)</label>
            <input type="number" id="res-min" value="120">
            <button onclick="doReserve()">ç«‹å³é¢„çº¦</button>
            <p style="color:#666;font-size:0.9rem;margin-top:15px">æç¤ºï¼šé¢„çº¦åè¯·ä½¿ç”¨ç»‘å®šçš„å®ä½“å¡åœ¨è®¾å¤‡ä¸Šç­¾åˆ°ã€‚</p>
        </div>
    </div>

    <div id="view-profile" class="view-section">
        <div class="card" style="max-width:500px; margin:0 auto">
            <h3>æˆ‘çš„ç»‘å¡ä¿¡æ¯</h3>
            <div style="background:#f8fafc; padding:20px; border-radius:8px; text-align:center; margin-bottom:20px">
                <div style="color:#64748b">å½“å‰ç»‘å®šå¡å· (UID)</div>
                <div id="my-uid" style="font-size:2rem; font-weight:bold; color:#1f2937; margin:10px 0">--</div>
                <div id="bind-tip" style="color:#ef4444">æœªç»‘å®š</div>
            </div>
            <label>ç»‘å®šæ–°å¡å· (è¾“å…¥å®ä½“å¡UID)</label>
            <input id="input-uid" placeholder="ä¾‹å¦‚: A1B2C3D4">
            <button onclick="doBind()">ä¿å­˜ç»‘å®š</button>
        </div>
    </div>

    {% if role == 'admin' %}
    <div id="view-admin" class="view-section">
        <div class="card">
            <h3>ç”¨æˆ·ç®¡ç†</h3>
            <div style="display:flex; gap:10px; margin-bottom:15px">
                <input id="adm-name" placeholder="ç”¨æˆ·å" style="margin:0">
                <input id="adm-uid" placeholder="å¡å·UID" style="margin:0">
                <button onclick="admAddUser()" style="width:auto">æ·»åŠ ç”¨æˆ·</button>
            </div>
            <table>
                <thead><tr><th>ç”¨æˆ·</th><th>å¡å·</th><th>è§’è‰²</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="user-table"></tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<script>
const CUR_USER = "{{ current_user }}";
const CUR_ROLE = "{{ role }}";

function switchView(id) {
    document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
    document.getElementById('view-' + id).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
    event.currentTarget.classList.add('active');
    document.getElementById('page-title').innerText = event.currentTarget.innerText.trim().substring(2);
    if(id === 'profile') loadProfile();
}

async function loadState() {
    try {
        const r = await fetch('/api/state');
        if(r.status === 401) return location.reload();
        const d = await r.json();

        // ç¯å¢ƒ
        if(d.latest) {
            document.getElementById('val-temp').innerText = d.latest.temp || '--';
            document.getElementById('val-humi').innerText = d.latest.humi || '--';
            document.getElementById('val-lux').innerText = d.latest.lux || '--';
            document.getElementById('val-time').innerText = (d.latest.created_at||'').split(' ')[1] || '--';
        }

        // åº§ä½
        const grid = document.getElementById('seat-grid');
        const sel = document.getElementById('res-seat');
        grid.innerHTML = '';
        if(sel.options.length <= 1) sel.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';

        d.seats.forEach(s => {
            // ç”Ÿæˆå¡ç‰‡
            const st = s.state;
            const cls = st === 'RESERVED' ? 'reserved' : (st === 'IN_USE' ? 'inuse' : 'free');
            const txt = st === 'RESERVED' ? 'å·²é¢„çº¦' : (st === 'IN_USE' ? 'ä½¿ç”¨ä¸­' : 'ç©ºé—²');

            // æ“ä½œæŒ‰é’®
            let btnHtml = '';
            const isMine = s.active_reservation?.user === CUR_USER;
            if(s.active_reservation && (CUR_ROLE === 'admin' || isMine)) {
                const action = s.active_reservation.status === 'ACTIVE' ? 'å–æ¶ˆé¢„çº¦' : 'å¼ºåˆ¶ç­¾é€€';
                btnHtml = `<button class="del" style="width:100%;margin-top:5px" onclick="event.stopPropagation();doCancel(${s.active_reservation.id})">${action}</button>`;
            }

            const div = document.createElement('div');
            div.className = `seat-item ${cls}`;
            div.innerHTML = `<div style="font-weight:bold;font-size:1.2rem">${s.display}</div><div style="font-size:0.9rem;margin:5px 0">${txt}</div>${btnHtml}`;

            if(st === 'FREE') {
                div.onclick = () => {
                    // æ¨¡æ‹Ÿç‚¹å‡»é¢„çº¦Tab
                    document.querySelectorAll('.nav-item')[1].click();
                    setTimeout(() => document.getElementById('res-seat').value = s.seat_id, 50);
                };
                // åŠ å…¥ä¸‹æ‹‰æ¡†
                if(!document.querySelector(`#res-seat option[value="${s.seat_id}"]`)) {
                    const opt = document.createElement('option');
                    opt.value = s.seat_id; opt.innerText = s.display;
                    sel.appendChild(opt);
                }
            }
            grid.appendChild(div);
        });

    } catch(e) {}
}

async function loadProfile() {
    const r = await fetch('/api/user/profile');
    if(r.ok) {
        const d = await r.json();
        const uid = d.uid || '';
        document.getElementById('my-uid').innerText = uid || 'æœªç»‘å®š';
        document.getElementById('bind-tip').innerText = uid ? 'âœ… çŠ¶æ€æ­£å¸¸' : 'âš ï¸ æ— æ³•é¢„çº¦';
        document.getElementById('bind-tip').style.color = uid ? '#10b981' : '#ef4444';
        document.getElementById('input-uid').value = uid;
    }
}

async function doBind() {
    const uid = document.getElementById('input-uid').value;
    if(!uid) return alert('è¯·è¾“å…¥UID');
    const r = await fetch('/api/user/bind', {method:'POST', body:JSON.stringify({uid})});
    const res = await r.json();
    if(res.ok) { alert('ç»‘å®šæˆåŠŸ'); loadProfile(); }
    else alert(res.error);
}

async function doReserve() {
    const sid = document.getElementById('res-seat').value;
    if(!sid) return alert('è¯·é€‰æ‹©åº§ä½');
    const r = await fetch('/api/reserve', {
        method:'POST', body:JSON.stringify({
            seat_id: sid, minutes: document.getElementById('res-min').value
        })
    });
    const res = await r.json();
    if(res.ok) {
        alert('é¢„çº¦æˆåŠŸï¼è¯·åœ¨15åˆ†é’Ÿå†…åˆ·å¡ç­¾åˆ°');
        document.querySelectorAll('.nav-item')[0].click(); // å›é¦–é¡µ
        loadState();
    } else {
        if(res.need_bind) {
            if(confirm(res.error + "\n\næ˜¯å¦å»ç»‘å®šï¼Ÿ")) document.querySelectorAll('.nav-item')[2].click();
        } else {
            alert(res.error);
        }
    }
}

async function doCancel(id) {
    if(confirm('ç¡®å®šå–æ¶ˆ/ç­¾é€€ï¼Ÿ')) {
        await fetch('/api/cancel', {method:'POST', body:JSON.stringify({reservation_id:id})});
        loadState();
    }
}

async function loadUsers() {
    const r = await fetch('/api/admin/users');
    if(!r.ok) return;
    const d = await r.json();
    const tb = document.getElementById('user-table');
    tb.innerHTML = '';
    d.users.forEach(u => {
        tb.innerHTML += `<tr><td>${u.username}</td><td>${u.uid||'-'}</td><td>${u.role}</td>
        <td><button class="del" onclick="delUser(${u.id})">åˆ é™¤</button></td></tr>`;
    });
}
async function admAddUser() {
    await fetch('/api/admin/users/add', {method:'POST', body:JSON.stringify({
        username: document.getElementById('adm-name').value,
        uid: document.getElementById('adm-uid').value
    })});
    loadUsers();
}
async function delUser(id) {
    if(confirm('åˆ é™¤?')) {
        await fetch('/api/admin/users/del', {method:'POST', body:JSON.stringify({id})});
        loadUsers();
    }
}

// åˆå§‹åŒ–
loadState();
setInterval(loadState, 2000);
if(CUR_ROLE === 'admin') loadUsers();
</script>
</body>
</html>