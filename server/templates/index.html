<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>æ™ºèƒ½è‡ªä¹ å®¤ç®¡ç†ç³»ç»Ÿ</title>
<style>
:root {
    --primary: #4361ee;
    --sidebar-bg: #1e293b;
    --sidebar-text: #f8fafc;
    --bg: #f1f5f9;
    --card-bg: #ffffff;
    --text: #334155;
}
body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

/* === ä¾§è¾¹æ æ ·å¼ === */
.sidebar { width: 240px; background: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); transition: width 0.3s; }
.sidebar h2 { font-size: 20px; margin: 0 0 30px 0; color: #fff; display: flex; align-items: center; gap: 10px; }
.nav-item { padding: 12px 15px; margin-bottom: 8px; cursor: pointer; border-radius: 8px; transition: all 0.2s; display: flex; align-items: center; gap: 12px; font-weight: 500; color: #94a3b8; }
.nav-item:hover { background: rgba(255,255,255,0.1); color: #fff; }
.nav-item.active { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3); }

/* === ä¸»å†…å®¹åŒº === */
.main-content { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
.header h1 { margin: 0; font-size: 24px; color: #1e293b; }
.user-info { font-size: 14px; color: #64748b; margin-right: 15px; }

/* === è§†å›¾åˆ‡æ¢ === */
.view-section { display: none; animation: fadeIn 0.3s; }
.view-section.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* === å¡ç‰‡ä¸ç»„ä»¶ === */
.card { background: var(--card-bg); border-radius: 16px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 24px; border: 1px solid #e2e8f0; }
.card h3 { margin: 0 0 20px 0; font-size: 18px; color: #334155; border-left: 4px solid var(--primary); padding-left: 12px; }

/* KPI Grid */
.kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
.kpi-box { background: #f8fafc; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #e2e8f0; transition: transform 0.2s; }
.kpi-box:hover { transform: translateY(-5px); border-color: var(--primary); }
.kpi-val { font-size: 32px; font-weight: 700; color: var(--primary); margin: 8px 0; }
.kpi-label { font-size: 13px; color: #64748b; text-transform: uppercase; letter-spacing: 1px; }

/* Seat Grid */
.seat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 16px; }
.seat-item {
    background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 15px 10px;
    text-align: center; cursor: pointer; transition: all 0.2s; position: relative;
}
.seat-item:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
.seat-item.free { border-color: #22c55e; background: #f0fdf4; color: #15803d; }
.seat-item.reserved { border-color: #f59e0b; background: #fffbeb; color: #b45309; }
.seat-item.inuse { border-color: #3b82f6; background: #eff6ff; color: #1d4ed8; }
.seat-item .icon { font-size: 28px; margin-bottom: 8px; display: block; }
.seat-item .name { font-weight: bold; font-size: 15px; }
.seat-item .status { font-size: 12px; opacity: 0.8; margin-top: 4px; }
.light-dot { width: 10px; height: 10px; border-radius: 50%; background: #cbd5e1; position: absolute; top: 10px; right: 10px; }
.light-dot.on { background: #eab308; box-shadow: 0 0 8px #eab308; }

/* Tables */
table { width: 100%; border-collapse: separate; border-spacing: 0; }
th { text-align: left; padding: 16px; background: #f8fafc; color: #475569; font-weight: 600; border-bottom: 1px solid #e2e8f0; }
td { padding: 16px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
tr:last-child td { border-bottom: none; }
.badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
.bg-free { background: #dcfce7; color: #166534; }
.bg-res { background: #fef3c7; color: #92400e; }
.bg-use { background: #dbeafe; color: #1e40af; }

/* Forms */
.form-group { margin-bottom: 15px; }
.form-group label { display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #64748b; }
input, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; transition: border 0.2s; box-sizing: border-box; }
input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1); }
button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
button:hover { background: #304ffe; }
button.del { background: #fee2e2; color: #ef4444; width: auto; padding: 6px 12px; font-size: 12px; }
button.del:hover { background: #fecaca; }

/* Responsive */
@media (max-width: 768px) {
    body { flex-direction: column; overflow: auto; }
    .sidebar { width: 100%; flex-direction: row; padding: 10px; overflow-x: auto; }
    .nav-item { margin-bottom: 0; margin-right: 10px; white-space: nowrap; }
    .main-content { overflow: visible; }
    .kpi-grid { grid-template-columns: 1fr 1fr; }
}
</style>
</head>
<body>

<div class="sidebar">
    <h2>ğŸ“š è‡ªä¹ å®¤ç³»ç»Ÿ</h2>
    <div class="nav-item active" onclick="switchView('dashboard')">
        <span>ğŸ“Š</span> æ€»è§ˆå¤§å±
    </div>
    <div class="nav-item" onclick="switchView('reserve')">
        <span>ğŸ“…</span> é¢„çº¦ä¸­å¿ƒ
    </div>

    {% if role == 'admin' %}
    <div class="nav-item" onclick="switchView('admin')">
        <span>âš™ï¸</span> åå°ç®¡ç†
    </div>
    {% endif %}

    <div class="nav-item" style="margin-top:auto" onclick="location.href='/logout'">
        <span>ğŸšª</span> é€€å‡ºç™»å½•
    </div>
</div>

<div class="main-content">

    <div class="header">
        <h1 id="page-title">æ€»è§ˆå¤§å±</h1>
        <div>
            <span class="user-info">ç”¨æˆ·: {{ current_user }} ({{ 'ç®¡ç†å‘˜' if role=='admin' else 'æ™®é€šç”¨æˆ·' }})</span>
            <span class="time-badge" id="clock">--:--:--</span>
        </div>
    </div>

    <div id="view-dashboard" class="view-section active">
        <div class="card">
            <h3>ğŸŒ¡ï¸ å®æ—¶ç¯å¢ƒç›‘æµ‹</h3>
            <div class="kpi-grid">
                <div class="kpi-box">
                    <div class="kpi-label">æ¸©åº¦</div>
                    <div class="kpi-val"><span id="temp">--</span><small style="font-size:16px">â„ƒ</small></div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-label">æ¹¿åº¦</div>
                    <div class="kpi-val"><span id="humi">--</span><small style="font-size:16px">%</small></div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-label">å…‰ç…§å¼ºåº¦</div>
                    <div class="kpi-val"><span id="lux">--</span><small style="font-size:16px">Lux</small></div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-label">æ•°æ®æ¥æº</div>
                    <div style="font-size: 18px; font-weight: bold; margin-top:12px; color:#475569" id="source_seat">--</div>
                    <div style="font-size: 12px; color:#94a3b8; margin-top:4px" id="update_time">åˆšåˆš</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px">
                <h3>ğŸª‘ åº§ä½å®æ—¶çŠ¶æ€</h3>
                <div style="font-size:13px; display:flex; gap:15px; align-items:center;">
                    <span style="display:flex;align-items:center"><div style="width:10px;height:10px;background:#22c55e;margin-right:6px;border-radius:2px"></div>ç©ºé—²</span>
                    <span style="display:flex;align-items:center"><div style="width:10px;height:10px;background:#f59e0b;margin-right:6px;border-radius:2px"></div>å·²é¢„çº¦</span>
                    <span style="display:flex;align-items:center"><div style="width:10px;height:10px;background:#3b82f6;margin-right:6px;border-radius:2px"></div>ä½¿ç”¨ä¸­</span>
                    <span style="display:flex;align-items:center"><div style="width:8px;height:8px;background:#eab308;border-radius:50%;margin-right:6px"></div>ç¯äº®</span>
                </div>
            </div>
            <div class="seat-grid" id="seatGrid"></div>

            {% if role != 'admin' %}
            <div style="margin-top:20px; font-size:14px; color:#666">
                æç¤ºï¼šæ‚¨å¯ä»¥ç‚¹å‡»ã€é¢„çº¦ä¸­å¿ƒã€‘è¿›è¡Œé€‰åº§ã€‚å¦‚æœæ‚¨å·²é¢„çº¦ï¼Œæ‚¨çš„åº§ä½å¡ç‰‡ä¸‹æ–¹ä¼šæ˜¾ç¤ºâ€œå–æ¶ˆâ€æŒ‰é’®ã€‚
            </div>
            {% endif %}
        </div>
    </div>

    <div id="view-reserve" class="view-section">
        <div class="card" style="max-width: 600px; margin: 0 auto;">
            <h3>ğŸ“… æäº¤æ–°é¢„çº¦</h3>
            <div class="form-group">
                <label>é€‰æ‹©åº§ä½</label>
                <select id="seatSelect"><option>æ­£åœ¨åŠ è½½åº§ä½ä¿¡æ¯...</option></select>
            </div>
            <div class="form-group">
                <label>é¢„çº¦äºº</label>
                <input id="userName" value="{{ current_user }}" disabled style="background:#f1f5f9; cursor:not-allowed">
            </div>
            <div class="form-group">
                <label>ä½¿ç”¨æ—¶é•¿ (åˆ†é’Ÿ)</label>
                <input type="number" id="minutes" value="120">
            </div>
            <button onclick="reserve()" id="btnReserve" style="margin-top:10px">ç«‹å³é¢„çº¦</button>
            <div id="resResult" style="margin-top:15px; text-align:center; font-size:14px;"></div>
        </div>
    </div>

    {% if role == 'admin' %}
    <div id="view-admin" class="view-section">
        <div style="display:flex; gap:20px; flex-wrap:wrap">
            <div style="flex:2; min-width:300px">
                <div class="card">
                    <h3>ğŸ“‹ åº§ä½ç®¡ç†åˆ—è¡¨</h3>
                    <div style="overflow-x:auto">
                        <table>
                            <thead>
                                <tr>
                                    <th>åº§ä½</th>
                                    <th>çŠ¶æ€</th>
                                    <th>ç¯å…‰ / æ¨¡å¼</th>
                                    <th>å½“å‰ç”¨æˆ·</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="seatTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div style="flex:1; min-width:300px">
                <div class="card">
                    <h3>ğŸ‘¥ ç”¨æˆ·åº“ç®¡ç†</h3>
                    <div class="form-group">
                        <input id="newUName" placeholder="å§“å">
                    </div>
                    <div class="form-group">
                        <input id="newUUid" placeholder="å¡å· (UID)">
                    </div>
                    <button onclick="addUser()">æ·»åŠ ç”¨æˆ·</button>

                    <div style="margin-top:20px; max-height:400px; overflow-y:auto; border-top:1px solid #eee">
                        <table style="margin-top:0">
                            <tbody id="userTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

</div>

<script>
// === æ³¨å…¥åç«¯å˜é‡ ===
const CURRENT_USER = "{{ current_user }}";
const CURRENT_ROLE = "{{ role }}";

// === åŸºç¡€é€»è¾‘ ===
setInterval(() => {
    document.getElementById('clock').innerText = new Date().toLocaleString();
}, 1000);

// === è§†å›¾åˆ‡æ¢ ===
function switchView(viewName) {
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    event.currentTarget.classList.add('active');
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    document.getElementById('view-' + viewName).classList.add('active');

    const titles = {'dashboard': 'æ€»è§ˆå¤§å±', 'reserve': 'é¢„çº¦ä¸­å¿ƒ', 'admin': 'åå°ç®¡ç†'};
    document.getElementById('page-title').innerText = titles[viewName];
}

// === æ•°æ®äº¤äº’ ===
async function fetchState(){
    try {
        const r = await fetch('/api/state');
        if(r.status === 401) location.reload(); // Session expired
        const d = await r.json();
        renderEnv(d.latest);
        renderSeats(d.seats);
    } catch(e) { console.error("Fetch error", e); }
}

function renderEnv(d) {
    if(!d) return;
    document.getElementById('temp').innerText = d.temp ?? '--';
    document.getElementById('humi').innerText = d.humi ?? '--';
    document.getElementById('lux').innerText  = d.lux ?? '--';
    document.getElementById('source_seat').innerText = d.seat_id ?? 'æœªè¿æ¥';
    document.getElementById('update_time').innerText = (d.created_at||'').split(' ')[1] || '--';
}

function renderSeats(seats) {
    const grid = document.getElementById('seatGrid');
    const sel = document.getElementById('seatSelect');
    const tb = document.getElementById('seatTable');

    const curSel = sel.value;

    grid.innerHTML = '';
    // åªæœ‰ç¬¬ä¸€æ¬¡æˆ–è€…åˆ—è¡¨ä¸ºç©ºæ—¶æ¸…ç©ºselectï¼Œé˜²æ­¢æ­£åœ¨é€‰æ‹©æ—¶è¢«åˆ·æ–°
    if(sel.options.length <= 1) sel.innerHTML = '<option value="">-- è¯·é€‰æ‹©åº§ä½ --</option>';

    // å¦‚æœæ˜¯ç®¡ç†å‘˜ç•Œé¢ï¼Œæ‰éœ€è¦æ¸²æŸ“ seatTable
    if(tb) tb.innerHTML = '';

    seats.forEach(s => {
        // 1. ç”Ÿæˆ Grid è§†å›¾
        const st = s.state;
        const cls = st==='RESERVED'?'reserved':(st==='IN_USE'?'inuse':'free');
        const icon = st==='RESERVED'?'ğŸ“…':(st==='IN_USE'?'ğŸ“š':'ğŸª‘');
        const statusText = st==='RESERVED'?'å·²é¢„çº¦':(st==='IN_USE'?'ä½¿ç”¨ä¸­':'ç©ºé—²');

        // æƒé™åˆ¤æ–­ï¼šæ˜¯å¦æ˜¾ç¤ºæ“ä½œæŒ‰é’®
        // ç®¡ç†å‘˜ï¼šæ°¸è¿œæ˜¾ç¤º
        // æ™®é€šç”¨æˆ·ï¼šåªæ˜¾ç¤ºè‡ªå·±çš„é¢„çº¦
        const isMyRes = s.active_reservation && s.active_reservation.user === CURRENT_USER;
        let actionHtml = '';
        if (s.active_reservation && (CURRENT_ROLE === 'admin' || isMyRes)) {
             const btnText = s.active_reservation.status === 'ACTIVE' ? 'å–æ¶ˆ' : 'ç­¾é€€';
             actionHtml = `<button class="del" style="margin-top:5px;width:100%" onclick="event.stopPropagation();cancelRes(${s.active_reservation.id})">${btnText}</button>`;
        }

        const div = document.createElement('div');
        div.className = `seat-item ${cls}`;
        div.innerHTML = `
            <div class="light-dot ${s.light_on?'on':''}"></div>
            <span class="icon">${icon}</span>
            <div class="name">${s.display}</div>
            <div class="status">${statusText}</div>
            ${actionHtml}
        `;

        div.onclick = () => {
            if(st === 'FREE') {
                switchView('reserve');
                setTimeout(() => document.getElementById('seatSelect').value = s.seat_id, 100);
            }
        };
        grid.appendChild(div);

        // 2. ç”Ÿæˆä¸‹æ‹‰èœå• (ç©ºé—²åº§ä½) - é¿å…é‡å¤æ·»åŠ 
        if(st === 'FREE') {
             if(!document.querySelector(`#seatSelect option[value="${s.seat_id}"]`)) {
                 const opt = document.createElement('option');
                 opt.value = s.seat_id;
                 opt.innerText = s.display;
                 sel.appendChild(opt);
             }
        } else {
             // å¦‚æœä¸ç©ºé—²ä½†å­˜åœ¨äºåˆ—è¡¨ä¸­ï¼Œç§»é™¤
             const exist = document.querySelector(`#seatSelect option[value="${s.seat_id}"]`);
             if(exist) exist.remove();
        }

        // 3. ç”Ÿæˆç®¡ç†åˆ—è¡¨ (ä»…ç®¡ç†å‘˜)
        if(tb) {
            const lightInfo = (s.light_on ? 'ğŸ’¡å¼€' : 'âš«å…³') + ' / ' + (s.light_mode==='AUTO'?'è‡ª':'æ‰‹');
            let btn = '';
            if(s.active_reservation) {
                const type = s.active_reservation.status === 'ACTIVE' ? 'å–æ¶ˆé¢„çº¦' : 'å¼ºåˆ¶ç­¾é€€';
                btn = `<button class="del" onclick="cancelRes(${s.active_reservation.id})">${type}</button>`;
            }
            const badgeCls = st==='FREE'?'bg-free':(st==='RESERVED'?'bg-res':'bg-use');

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${s.display}</td>
                <td><span class="badge ${badgeCls}">${statusText}</span></td>
                <td><span style="font-size:12px;color:#64748b">${lightInfo}</span></td>
                <td>${s.active_reservation?.user || '--'}</td>
                <td>${btn}</td>
            `;
            tb.appendChild(tr);
        }
    });

    if(curSel && document.querySelector(`#seatSelect option[value="${curSel}"]`)) {
        sel.value = curSel;
    }
}

// === ä¸šåŠ¡æ“ä½œ ===
async function reserve() {
    const sid = document.getElementById('seatSelect').value;
    const btn = document.getElementById('btnReserve');

    if(!sid) return alert('è¯·é€‰æ‹©åº§ä½');

    btn.disabled = true; btn.innerText = "æäº¤ä¸­...";

    try {
        const r = await fetch('/api/reserve', {
            method: 'POST',
            body: JSON.stringify({
                seat_id: sid,
                // user å­—æ®µç”±åç«¯ session æ§åˆ¶ï¼Œå‰ç«¯ä¸éœ€è¦ä¼ ï¼Œæˆ–è€…ä¼ äº†åç«¯ä¹Ÿä¼šæ ¡éªŒè¦†ç›–
                minutes: document.getElementById('minutes').value
            })
        });
        const res = await r.json();
        if(res.ok) {
            alert('âœ… é¢„çº¦æˆåŠŸï¼');
            fetchState();
            switchView('dashboard');
        } else {
            alert('âŒ å¤±è´¥: ' + res.error);
        }
    } catch(e) { alert('ç½‘ç»œé”™è¯¯'); }

    btn.disabled = false; btn.innerText = "ç«‹å³é¢„çº¦";
}

async function cancelRes(id) {
    if(confirm('âš ï¸ ç¡®å®šè¦å–æ¶ˆæˆ–ç»“æŸæ­¤é¢„çº¦å—ï¼Ÿ')) {
        await fetch('/api/cancel', {method:'POST', body:JSON.stringify({reservation_id:id})});
        fetchState();
    }
}

// ä»…ç®¡ç†å‘˜ä¼šè°ƒç”¨
async function fetchUsers() {
    if(CURRENT_ROLE !== 'admin') return;
    const r = await fetch('/api/users');
    if(r.status === 403) return; // æ— æƒé™
    const d = await r.json();
    const tb = document.getElementById('userTable');
    if(!tb) return;

    tb.innerHTML = '';
    d.users.forEach(u => {
        tb.innerHTML += `
            <tr>
                <td>
                    <div style="font-weight:600">${u.username} <span style="font-weight:normal;color:#999">(${u.role})</span></div>
                    <div style="font-size:12px;color:#94a3b8">${u.uid||'æ— å¡å·'}</div>
                </td>
                <td style="text-align:right">
                    <button class="del" onclick="delUser(${u.id})">åˆ é™¤</button>
                </td>
            </tr>`;
    });
}

async function addUser() {
    const name = document.getElementById('newUName').value;
    if(!name) return alert('å§“åå¿…å¡«');
    const r = await fetch('/api/users/add', {
        method: 'POST',
        body: JSON.stringify({
            username: name,
            uid: document.getElementById('newUUid').value
        })
    });
    const res = await r.json();
    if(res.ok) {
        document.getElementById('newUName').value = '';
        document.getElementById('newUUid').value = '';
        fetchUsers();
    } else {
        alert(res.error);
    }
}

async function delUser(id) {
    if(confirm('ç¡®å®šåˆ é™¤è¯¥ç”¨æˆ·ï¼Ÿ')) {
        await fetch('/api/users/delete', {method:'POST', body:JSON.stringify({id})});
        fetchUsers();
    }
}

// === åˆå§‹åŒ– ===
fetchState();
if(CURRENT_ROLE === 'admin') fetchUsers();
setInterval(fetchState, 2000);
</script>
</body>
</html>